###############################################################################
#                                                                             #
# IAR 8051 C/C++ Compiler V7.30B/W32                    28/Oct/2013  18:58:25 #
# Copyright 2004-2007 IAR Systems. All rights reserved.                       #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data                                               #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\8-22\修改中2013.8.12Texas Instruments           #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\ZMa #
#                          in\TI2430DB\ZMain.c                                #
#    Command line       =  -f "C:\8-22\修改中2013.8.12Texas Instruments       #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\..\..\Tools\CC24 #
#                          30DB\f8wCoord.cfg" (-DCPU32MHZ -DFORCE_MAC_NEAR    #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DZDO_COORDINATOR -DRTR_NWK -DBLINK_LEDS         #
#                          "-DCONST=const __code" -DGENERIC=__generic) -f     #
#                          "C:\8-22\修改中2013.8.12Texas Instruments          #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\..\..\Tools\CC24 #
#                          30DB\f8wConfig.cfg" (-DSECURE=0                    #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0x1234                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=30            #
#                          -DMAX_RREQ_ENTRIES=10 -DAPSC_MAX_FRAME_RETRIES=3   #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=20           #
#                          -DNWK_MAX_BINDING_ENTRIES=10                       #
#                          -DMAX_BINDING_CLUSTER_IDS=5 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=10000       #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "C:\8-22\修改中2013.8.12Tex #
#                          as Instruments longmenshan\ZStack-1.4.3-1.2.1\Proj #
#                          ects\zstack\ZMain\TI2430DB\ZMain.c" -D CC2430EB    #
#                          -D xREFLECTOR -D ZTOOL_P1 -D MT_TASK -D            #
#                          MT_ZDO_FUNC -D xLCD_SUPPORTED=DEBUG -D NV_RESTORE  #
#                          -lC "C:\8-22\修改中2013.8.12Texas Instruments      #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\CoordinatorEB\List\ #
#                          " -lA "C:\8-22\修改中2013.8.12Texas Instruments    #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\CoordinatorEB\List\ #
#                          " --diag_suppress Pe001,Pa010 --diag_remark pe550  #
#                          -o "C:\8-22\修改中2013.8.12Texas Instruments       #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\CoordinatorEB\Obj\" #
#                           -e --require_prototypes -z9 --no_code_motion      #
#                          --debug --core=plain --dptr=16,1                   #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data --nr_virtual_regs 8 -I      #
#                          "C:\8-22\修改中2013.8.12Texas Instruments          #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\" -I                #
#                          "C:\8-22\修改中2013.8.12Texas Instruments          #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\SOURCE\" -I      #
#                          "C:\8-22\修改中2013.8.12Texas Instruments          #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\..\..\ZMAIN\TI24 #
#                          30DB\" -I "C:\8-22\修改中2013.8.12Texas            #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MT\"   #
#                          -I "C:\8-22\修改中2013.8.12Texas Instruments       #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\..\..\..\..\COMP #
#                          ONENTS\HAL\INCLUDE\" -I "C:\8-22\修改中2013.8.12Te #
#                          xas Instruments longmenshan\ZStack-1.4.3-1.2.1\Pro #
#                          jects\zstack\Samples\network                       #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\HAL\TA #
#                          RGET\CC2430EB\" -I "C:\8-22\修改中2013.8.12Texas   #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\OSAL\M #
#                          CU\CCSOC\" -I "C:\8-22\修改中2013.8.12Texas        #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\OSAL\I #
#                          NCLUDE\" -I "C:\8-22\修改中2013.8.12Texas          #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          AF\" -I "C:\8-22\修改中2013.8.12Texas Instruments  #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\..\..\..\..\COMP #
#                          ONENTS\STACK\NWK\" -I "C:\8-22\修改中2013.8.12Texa #
#                          s Instruments longmenshan\ZStack-1.4.3-1.2.1\Proje #
#                          cts\zstack\Samples\network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          SEC\" -I "C:\8-22\修改中2013.8.12Texas             #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          SYS\" -I "C:\8-22\修改中2013.8.12Texas             #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          ZDO\" -I "C:\8-22\修改中2013.8.12Texas             #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\ZMAC\F #
#                          8W\" -I "C:\8-22\修改中2013.8.12Texas Instruments  #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\..\..\..\..\..\COMP #
#                          ONENTS\ZMAC\" -I "C:\8-22\修改中2013.8.12Texas     #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\SERVIC #
#                          ES\SADDR\" -I "C:\8-22\修改中2013.8.12Texas        #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\SERVIC #
#                          ES\SDATA\" -I "C:\8-22\修改中2013.8.12Texas        #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\IN #
#                          CLUDE\" -I "C:\8-22\修改中2013.8.12Texas           #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\HI #
#                          GH_LEVEL\" -I "C:\8-22\修改中2013.8.12Texas        #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\LO #
#                          W_LEVEL\SRF03\" -I "C:\8-22\修改中2013.8.12Texas   #
#                          Instruments longmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\network                           #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\LO #
#                          W_LEVEL\SRF03\SINGLE_CHIP\" -I "C:\Program         #
#                          Files\IAR Systems\Embedded Workbench 4.0           #
#                          Evaluation version\8051\INC\" -I "C:\Program       #
#                          Files\IAR Systems\Embedded Workbench 4.0           #
#                          Evaluation version\8051\INC\CLIB\"                 #
#    List file          =  C:\8-22\修改中2013.8.12Texas Instruments           #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\CoordinatorEB\List\ #
#                          ZMain.lst                                          #
#    Object file        =  C:\8-22\修改中2013.8.12Texas Instruments           #
#                          longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Sam #
#                          ples\network formaton\CC2430DB\CoordinatorEB\Obj\Z #
#                          Main.r51                                           #
#                                                                             #
#                                                                             #
###############################################################################

C:\8-22\修改中2013.8.12Texas Instruments longmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\ZMain\TI2430DB\ZMain.c
      1          /**************************************************************************************************
      2            Filename:       ZMain.c
      3            Revised:        $Date: 2007-10-27 17:16:54 -0700 (Sat, 27 Oct 2007) $
      4            Revision:       $Revision: 15793 $
      5            
      6            Description:    Startup and shutdown code for ZStack
      7            Notes:          This version targets the Chipcon CC2430DB/CC2430EB
      8          
      9          
     10            Copyright 2005-2007 Texas Instruments Incorporated. All rights reserved.
     11          
     12            IMPORTANT: Your use of this Software is limited to those specific rights
     13            granted under the terms of a software license agreement between the user
     14            who downloaded the software, his/her employer (which must be your employer)
     15            and Texas Instruments Incorporated (the "License").  You may not use this
     16            Software unless you agree to abide by the terms of the License. The License
     17            limits your use, and you acknowledge, that the Software may not be modified,
     18            copied or distributed unless embedded on a Texas Instruments microcontroller
     19            or used solely and exclusively in conjunction with a Texas Instruments radio
     20            frequency transceiver, which is integrated into your product.  Other than for
     21            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     22            works of, modify, distribute, perform, display or sell this Software and/or
     23            its documentation for any purpose.
     24          
     25            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     26            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     27            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     28            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     29            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     30            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     31            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     32            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     33            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     34            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     35            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     36          
     37            Should you have any questions regarding your right to use this Software,
     38            contact Texas Instruments Incorporated at www.TI.com. 
     39          **************************************************************************************************/
     40          
     41          /*********************************************************************
     42           * INCLUDES
     43           */
     44          
     45          #include "ZComDef.h"
     46          #include "OSAL.h"
     47          #include "OSAL_Memory.h"
     48          #include "OSAL_Nv.h"
     49          #include "OnBoard.h"

   \                                 In  segment SFR_AN, at 0x81
   \   unsigned char volatile __sfr SP
   \                     `SP`:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0x8f
   \   unsigned char volatile __sfr P0INP
   \                     P0INP:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xbe
   \   unsigned char volatile __sfr SLEEP
   \                     SLEEP:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xc6
   \   unsigned char volatile __sfr CLKCON
   \                     CLKCON:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xfe
   \   unsigned char volatile __sfr P1DIR
   \                     P1DIR:
   \   000000                DS 1
     50          #include "ZMAC.h"
     51          #include "MTEL.h"
     52          
     53          #include "nwk_globals.h"
     54          #include "ZDApp.h"
     55          #include "ssp.h"
     56          #include "ZGlobals.h"
     57          
     58          #ifndef NONWK
     59            #include "AF.h"
     60          #endif
     61          
     62          /* Hal */
     63          #include "hal_lcd.h"
     64          #include "hal_key.h"
     65          #include "hal_led.h"
     66          #include "hal_adc.h"
     67          #include "hal_drivers.h"
     68          #include "hal_assert.h"
     69          
     70          
     71          /*********************************************************************
     72           * MACROS
     73           */
     74          
     75          /*********************************************************************
     76           * CONSTANTS
     77           */
     78          
     79          // LED Flash counter, waiting for default 64-bit address
     80          #define FLASH_COUNT 20000
     81          
     82          // Maximun number of Vdd samples checked before go on
     83          #define MAX_VDD_SAMPLES  3
     84          #define ZMAIN_VDD_LIMIT  HAL_ADC_VDD_LIMIT_4
     85          
     86          /*********************************************************************
     87           * TYPEDEFS
     88           */
     89          
     90          /*********************************************************************
     91           * GLOBAL VARIABLES
     92           */
     93          
     94          /*********************************************************************
     95           * EXTERNAL VARIABLES
     96           */
     97          
     98          /*********************************************************************
     99           * EXTERNAL FUNCTIONS
    100           */
    101          
    102          extern __near_func uint8 GetCodeByte(uint32);
    103          
    104          extern bool HalAdcCheckVdd (uint8 limit);
    105          
    106          /*********************************************************************
    107           * LOCAL VARIABLES
    108           */
    109          
    110          /*********************************************************************
    111           * ZMAIN API JUMP FUNCTIONS
    112           *
    113           * If the MINIMIZE_ROOT compile flag is defined, ZMAIN API functions
    114           * are implemented as "jump functions" located in the ROOT segment,
    115           * as expected by the NWK object libraries. This allows the actual
    116           * ZMAIN function bodies to locate outside ROOT memory, increasing
    117           * space for user defined constants, strings, etc in ROOT memory.
    118           *
    119           * If the MINIMIZE_ROOT compile flag in not defined, the ZMAIN API
    120           * functions are aliased to the similarly-named function bodies and
    121           * located in the ROOT segment with no "jump function" overhead.
    122           * This is the default behavior which produces smaller overall code
    123           * size and maximizes available code space in BANK1...BANK3.
    124           *
    125           */
    126          
    127          #ifdef MINIMIZE_ROOT
    128            // ZMAIN functions are not forced into ROOT segment
    129            #define ZSEG
    130          #else
    131            // ZMAIN functions are forced into ROOT segment
    132            #define ZSEG ROOT
    133          #endif
    134          
    135          /*********************************************************************
    136           * LOCAL FUNCTIONS
    137           */
    138          
    139          static ZSEG void zmain_dev_info( void );
    140          static ZSEG void zmain_ext_addr( void );
    141          static ZSEG void zmain_ram_init( void );
    142          static ZSEG void zmain_vdd_check( void );
    143          
    144          #ifdef LCD_SUPPORTED
    145          static ZSEG void zmain_lcd_init( void );
    146          #endif
    147          
    148          /*********************************************************************
    149           * @fn      main
    150           * @brief   First function called after startup.
    151           * @return  don't care
    152           *********************************************************************/

   \                                 In  segment NEAR_CODE, align 1, keep-with-next
    153          ZSEG int main( void )
   \                     main:
    154          {
   \   000000                ; Auto size: 0
    155            // Turn off interrupts
    156            osal_int_disable( INTS_ALL );
   \   000000                ; Setup parameters for call to function osal_int_disable
   \   000000   79FF         MOV     R1,#-0x1
   \   000002   12....       LCALL   ??osal_int_disable?relay
    157          
    158            // Initialize HAL
    159            HAL_BOARD_INIT();
   \   000005   53BEFB       ANL     0xbe,#0xfb
   \                     ??main_0:
   \   000008   E5BE         MOV     A,0xbe
   \   00000A   A2E6         MOV     C,0xE0 /* A   */.6
   \   00000C   50FA         JNC     ??main_0
   \   00000E   00           NOP
   \   00000F   78F8         MOV     R0,#-0x8
   \   000011   7901         MOV     R1,#0x1
   \                     ??main_1:
   \   000013   00           NOP
   \   000014   E8           MOV     A,R0
   \   000015   24FF         ADD     A,#-0x1
   \   000017   18           DEC     R0
   \   000018   E9           MOV     A,R1
   \   000019   34FF         ADDC    A,#-0x1
   \   00001B   F9           MOV     R1,A
   \   00001C   E8           MOV     A,R0
   \   00001D   7001         JNZ     ??main_2
   \   00001F   E9           MOV     A,R1
   \                     ??main_2:
   \   000020   70F1         JNZ     ??main_1
   \   000022   75C600       MOV     0xc6,#0x0
   \                     ??main_3:
   \   000025   E5C6         MOV     A,0xc6
   \   000027   70FC         JNZ     ??main_3
   \   000029   43BE04       ORL     0xbe,#0x4
   \   00002C   43FE01       ORL     0xfe,#0x1
   \   00002F   43FE08       ORL     0xfe,#0x8
   \   000032   438F20       ORL     0x8f,#0x20
    160          
    161            // Make sure supply voltage is high enough to run
    162            zmain_vdd_check();
   \   000035                ; Setup parameters for call to function zmain_vdd_check
   \   000035   12....       LCALL   zmain_vdd_check
    163          
    164            // Initialize stack memory
    165            zmain_ram_init();
   \   000038   78..         MOV     R0,#(SFB(XSP) & 0xff)
   \   00003A   8682         MOV     DPL,@R0
   \   00003C   08           INC     R0
   \   00003D   8683         MOV     DPH,@R0
   \   00003F   8003         SJMP    ??main_4
   \                     ??main_5:
   \   000041   74CD         MOV     A,#-0x33
   \   000043   F0           MOVX    @DPTR,A
   \                     ??main_4:
   \   000044   12....       LCALL   ?Subroutine0
   \                     ??CrossCallReturnLabel_0:
   \   000047   C3           CLR     C
   \   000048   74..         MOV     A,#(SFB(XSTACK) & 0xff)
   \   00004A   9582         SUBB    A,DPL
   \   00004C   74..         MOV     A,#((SFB(XSTACK) >> 8) & 0xff)
   \   00004E   9583         SUBB    A,DPH
   \   000050   40EF         JC      ??main_5
   \   000052   7582..       MOV     DPL,#((SFE(ISTACK) + 255) & 0xff)
   \   000055   7583..       MOV     DPH,#(((SFE(ISTACK) - 1) >> 8) & 0xff)
   \   000058   8004         SJMP    ??main_6
   \                     ??main_7:
   \   00005A   A882         MOV     R0,DPL
   \   00005C   76CD         MOV     @R0,#-0x33
   \                     ??main_6:
   \   00005E   E581         MOV     A,0x81
   \   000060   F5..         MOV     ?V0 + 0,A
   \   000062   12....       LCALL   ?Subroutine0
   \                     ??CrossCallReturnLabel_1:
   \   000065   75..00       MOV     ?V0 + 1,#0x0
   \   000068   C3           CLR     C
   \   000069   E5..         MOV     A,?V0 + 0
   \   00006B   9582         SUBB    A,DPL
   \   00006D   E4           CLR     A
   \   00006E   9583         SUBB    A,DPH
   \   000070   40E8         JC      ??main_7
    166          
    167            // Initialize board I/O
    168            InitBoard( OB_COLD );
   \   000072                ; Setup parameters for call to function InitBoard
   \   000072   7900         MOV     R1,#0x0
   \   000074   12....       LCALL   ??InitBoard?relay
    169          
    170            // Initialze HAL drivers
    171            HalDriverInit();
   \   000077                ; Setup parameters for call to function HalDriverInit
   \   000077   12....       LCALL   ??HalDriverInit?relay
    172          
    173            // Initialize NV System
    174            osal_nv_init( NULL );
   \   00007A                ; Setup parameters for call to function osal_nv_init
   \   00007A   7A00         MOV     R2,#0x0
   \   00007C   7B00         MOV     R3,#0x0
   \   00007E   12....       LCALL   ??osal_nv_init?relay
    175          
    176            // Determine the extended address
    177            zmain_ext_addr();
   \   000081                ; Setup parameters for call to function zmain_ext_addr
   \   000081   12....       LCALL   zmain_ext_addr
    178          
    179            // Initialize basic NV items
    180            zgInit();
   \   000084                ; Setup parameters for call to function zgInit
   \   000084   12....       LCALL   ??zgInit?relay
    181          
    182            // Initialize the MAC
    183            ZMacInit();
   \   000087                ; Setup parameters for call to function ZMacInit
   \   000087   12....       LCALL   ZMacInit
    184          
    185          #ifndef NONWK
    186            // Since the AF isn't a task, call it's initialization routine
    187            afInit();
   \   00008A                ; Setup parameters for call to function afInit
   \   00008A   12....       LCALL   ??afInit?relay
    188          #endif
    189          
    190            // Initialize the operating system
    191            osal_init_system();
   \   00008D                ; Setup parameters for call to function osal_init_system
   \   00008D   12....       LCALL   ??osal_init_system?relay
    192          
    193            // Allow interrupts
    194            osal_int_enable( INTS_ALL );
   \   000090                ; Setup parameters for call to function osal_int_enable
   \   000090   79FF         MOV     R1,#-0x1
   \   000092   12....       LCALL   ??osal_int_enable?relay
    195          
    196            // Final board initialization
    197            InitBoard( OB_READY );
   \   000095                ; Setup parameters for call to function InitBoard
   \   000095   7902         MOV     R1,#0x2
   \   000097   12....       LCALL   ??InitBoard?relay
    198          
    199            // Display information about this device
    200            zmain_dev_info();
    201          
    202            /* Display the device info on the LCD */
    203          #ifdef LCD_SUPPORTED
    204            zmain_lcd_init();
    205          #endif
    206          
    207            osal_start_system(); // No Return from here
   \   00009A                ; Setup parameters for call to function osal_start_system
   \   00009A   12....       LCALL   ??osal_start_system?relay
    208          } // main()
   \   00009D   7A00         MOV     R2,#0x0
   \   00009F   7B00         MOV     R3,#0x0
   \   0000A1   22           RET
   \   0000A2                REQUIRE P0INP
   \   0000A2                REQUIRE SLEEP
   \   0000A2                REQUIRE P1DIR
   \   0000A2                REQUIRE CLKCON
   \   0000A2                REQUIRE `SP`
    209          
    210          /*********************************************************************
    211           * @fn      zmain_vdd_check
    212           * @brief   Check if the Vdd is OK to run the processor.
    213           * @return  Return if Vdd is ok; otherwise, flash LED, then reset
    214           *********************************************************************/

   \                                 In  segment NEAR_CODE, align 1, keep-with-next
    215          static ZSEG void zmain_vdd_check( void )
   \                     zmain_vdd_check:
    216          {
   \   000000   74F8         MOV     A,#-0x8
   \   000002   12....       LCALL   ?FUNC_ENTER_XDATA
   \   000005                ; Saved register size: 8
   \   000005                ; Auto size: 0
    217            uint8 vdd_passed_count = 0;
   \   000005   7E00         MOV     R6,#0x0
    218            bool toggle = 0;
   \   000007   7F00         MOV     R7,#0x0
    219          
    220            // Repeat getting the sample until number of failures or successes hits MAX
    221            // then based on the count value, determine if the device is ready or not
    222            while ( vdd_passed_count < MAX_VDD_SAMPLES )
    223            {
    224              if ( HalAdcCheckVdd (ZMAIN_VDD_LIMIT) )
   \                     ??zmain_vdd_check_0:
   \   000009                ; Setup parameters for call to function HalAdcCheckVdd
   \   000009   7904         MOV     R1,#0x4
   \   00000B   12....       LCALL   ??HalAdcCheckVdd?relay
   \   00000E   E9           MOV     A,R1
   \   00000F   6019         JZ      ??zmain_vdd_check_1
    225              {
    226                vdd_passed_count++;    // Keep track # times Vdd passes in a row
   \   000011   0E           INC     R6
    227                MicroWait (10000);     // Wait 10ms to try again
   \   000012                ; Setup parameters for call to function Onboard_wait
   \   000012   7A10         MOV     R2,#0x10
   \   000014   7B27         MOV     R3,#0x27
   \   000016   12....       LCALL   ??Onboard_wait?relay
    228              }
    229              else
    230              {
    231                vdd_passed_count = 0;  // Reset passed counter
    232                MicroWait (50000);     // Wait 50ms
    233                MicroWait (50000);     // Wait another 50ms to try again
    234              }
    235          
    236              /* toggle LED1 and LED2 */
    237              if (vdd_passed_count == 0)
   \   000019   EE           MOV     A,R6
   \   00001A   601E         JZ      ??zmain_vdd_check_2
   \   00001C   C3           CLR     C
   \   00001D   9403         SUBB    A,#0x3
   \   00001F   40E8         JC      ??zmain_vdd_check_0
    238              {
    239                if ((toggle = !(toggle)))
    240                  HAL_TOGGLE_LED1();
    241                else
    242                  HAL_TOGGLE_LED2();
    243              }
    244            }
    245          
    246            /* turn off LED1 */
    247            HAL_TURN_OFF_LED1();
   \   000021   D290         SETB    0x90.0
    248            HAL_TURN_OFF_LED2();
   \   000023   D293         SETB    0x90.3
    249          }
   \   000025   7F01         MOV     R7,#0x1
   \   000027   02....       LJMP    ?FUNC_LEAVE_XDATA
   \                     ??zmain_vdd_check_1:
   \   00002A   7E00         MOV     R6,#0x0
   \   00002C                ; Setup parameters for call to function Onboard_wait
   \   00002C   7A50         MOV     R2,#0x50
   \   00002E   7BC3         MOV     R3,#-0x3d
   \   000030   12....       LCALL   ??Onboard_wait?relay
   \   000033                ; Setup parameters for call to function Onboard_wait
   \   000033   7A50         MOV     R2,#0x50
   \   000035   7BC3         MOV     R3,#-0x3d
   \   000037   12....       LCALL   ??Onboard_wait?relay
   \                     ??zmain_vdd_check_2:
   \   00003A   EF           MOV     A,R7
   \   00003B   7004         JNZ     ??zmain_vdd_check_3
   \   00003D   7A01         MOV     R2,#0x1
   \   00003F   8002         SJMP    ??zmain_vdd_check_4
   \                     ??zmain_vdd_check_3:
   \   000041   7A00         MOV     R2,#0x0
   \                     ??zmain_vdd_check_4:
   \   000043   EA           MOV     A,R2
   \   000044   FF           MOV     R7,A
   \   000045   600C         JZ      ??zmain_vdd_check_5
   \   000047   A290         MOV     C,0x90.0
   \   000049   5004         JNC     ??zmain_vdd_check_6
   \   00004B   C290         CLR     0x90.0
   \   00004D   80BA         SJMP    ??zmain_vdd_check_0
   \                     ??zmain_vdd_check_6:
   \   00004F   D290         SETB    0x90.0
   \   000051   80B6         SJMP    ??zmain_vdd_check_0
   \                     ??zmain_vdd_check_5:
   \   000053   A293         MOV     C,0x90.3
   \   000055   5004         JNC     ??zmain_vdd_check_7
   \   000057   C293         CLR     0x90.3
   \   000059   80AE         SJMP    ??zmain_vdd_check_0
   \                     ??zmain_vdd_check_7:
   \   00005B   D293         SETB    0x90.3
   \   00005D   80AA         SJMP    ??zmain_vdd_check_0
   \   00005F                REQUIRE _A_P1
    250          
    251          /*********************************************************************
    252           * @fn      zmain_ext_addr
    253           * @brief   Makes extended address if none exists.
    254           * @return  none
    255           *********************************************************************/

   \                                 In  segment NEAR_CODE, align 1, keep-with-next
    256          static ZSEG void zmain_ext_addr( void )
   \                     zmain_ext_addr:
    257          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?FUNC_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    258            uint8 i;
    259            uint8 led;
    260            uint8 tmp;
    261            uint8 *xad;
    262            uint16 AtoD;
    263          
    264            // Initialize extended address in NV
    265            osal_nv_item_init( ZCD_NV_EXTADDR, Z_EXTADDR_LEN, NULL );
   \   000005                ; Setup parameters for call to function osal_nv_item_init
   \   000005   75..00       MOV     ?V0 + 0,#0x0
   \   000008   75..00       MOV     ?V0 + 1,#0x0
   \   00000B   78..         MOV     R0,#?V0 + 0
   \   00000D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000010   7C08         MOV     R4,#0x8
   \   000012   7D00         MOV     R5,#0x0
   \   000014   7A01         MOV     R2,#0x1
   \   000016   7B00         MOV     R3,#0x0
   \   000018   12....       LCALL   ??osal_nv_item_init?relay
   \   00001B   7402         MOV     A,#0x2
   \   00001D   12....       LCALL   ?DEALLOC_XSTACK8
    266            osal_nv_read( ZCD_NV_EXTADDR, 0, Z_EXTADDR_LEN, &aExtendedAddress );
   \   000020                ; Setup parameters for call to function osal_nv_read
   \   000020   75....       MOV     ?V0 + 0,#(aExtendedAddress & 0xff)
   \   000023   75....       MOV     ?V0 + 1,#((aExtendedAddress >> 8) & 0xff)
   \   000026   78..         MOV     R0,#?V0 + 0
   \   000028   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00002B   75..08       MOV     ?V0 + 0,#0x8
   \   00002E   75..00       MOV     ?V0 + 1,#0x0
   \   000031   78..         MOV     R0,#?V0 + 0
   \   000033   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000036   7C00         MOV     R4,#0x0
   \   000038   7D00         MOV     R5,#0x0
   \   00003A   7A01         MOV     R2,#0x1
   \   00003C   7B00         MOV     R3,#0x0
   \   00003E   12....       LCALL   ??osal_nv_read?relay
   \   000041   7404         MOV     A,#0x4
   \   000043   12....       LCALL   ?DEALLOC_XSTACK8
    267          
    268            // Check for uninitialized value (erased EEPROM = 0xFF)
    269            xad = (uint8*)&aExtendedAddress;
   \   000046   78..         MOV     R0,#(aExtendedAddress & 0xff)
   \   000048   79..         MOV     R1,#((aExtendedAddress >> 8) & 0xff)
    270            for ( i = 0; i < Z_EXTADDR_LEN; i++ )
   \   00004A   7C00         MOV     R4,#0x0
    271              if ( *xad++ != 0xFF ) return;
   \                     ??zmain_ext_addr_0:
   \   00004C   E8           MOV     A,R0
   \   00004D   FA           MOV     R2,A
   \   00004E   E9           MOV     A,R1
   \   00004F   FB           MOV     R3,A
   \   000050   8A82         MOV     DPL,R2
   \   000052   8B83         MOV     DPH,R3
   \   000054   A3           INC     DPTR
   \   000055   A882         MOV     R0,DPL
   \   000057   A983         MOV     R1,DPH
   \   000059   8A82         MOV     DPL,R2
   \   00005B   8B83         MOV     DPH,R3
   \   00005D   E0           MOVX    A,@DPTR
   \   00005E   64FF         XRL     A,#0xff
   \   000060   6003         JZ      $+5
   \   000062   02....       LJMP    ??zmain_ext_addr_1
   \   000065   0C           INC     R4
   \   000066   EC           MOV     A,R4
   \   000067   C3           CLR     C
   \   000068   9408         SUBB    A,#0x8
   \   00006A   40E0         JC      ??zmain_ext_addr_0
    272          
    273          #ifdef ZDO_COORDINATOR
    274            tmp = 0x10;
   \   00006C   7B10         MOV     R3,#0x10
    275          #else
    276            tmp = 0x20;
    277          #endif
    278            // Initialize with a simple pattern
    279            xad = (uint8*)&aExtendedAddress;
   \   00006E   78..         MOV     R0,#(aExtendedAddress & 0xff)
   \   000070   79..         MOV     R1,#((aExtendedAddress >> 8) & 0xff)
    280            for ( i = 0; i < Z_EXTADDR_LEN; i++ )
   \   000072   7A08         MOV     R2,#0x8
    281              *xad++ = tmp++;
   \                     ??zmain_ext_addr_2:
   \   000074   EB           MOV     A,R3
   \   000075   8882         MOV     DPL,R0
   \   000077   8983         MOV     DPH,R1
   \   000079   F0           MOVX    @DPTR,A
   \   00007A   0B           INC     R3
   \   00007B   A3           INC     DPTR
   \   00007C   A882         MOV     R0,DPL
   \   00007E   A983         MOV     R1,DPH
   \   000080   1A           DEC     R2
   \   000081   EA           MOV     A,R2
   \   000082   70F0         JNZ     ??zmain_ext_addr_2
    282          
    283            // Flash LED1 until user hits SW5
    284            led = HAL_LED_MODE_OFF;
   \   000084   75..00       MOV     ?V0 + 0,#0x0
   \   000087   8018         SJMP    ??zmain_ext_addr_3
    285            while ( HAL_KEY_SW_5 != HalKeyRead() )
    286            {
    287              MicroWait( 62500 );
   \                     ??zmain_ext_addr_4:
   \   000089                ; Setup parameters for call to function Onboard_wait
   \   000089   7A24         MOV     R2,#0x24
   \   00008B   7BF4         MOV     R3,#-0xc
   \   00008D   12....       LCALL   ??Onboard_wait?relay
    288              HalLedSet( HAL_LED_1, led^=HAL_LED_MODE_ON );  // Toggle the LED
   \   000090   63..01       XRL     ?V0 + 0,#0x1
   \   000093                ; Setup parameters for call to function HalLedSet
   \   000093   AA..         MOV     R2,?V0 + 0
   \   000095   7901         MOV     R1,#0x1
   \   000097   12....       LCALL   ??HalLedSet?relay
    289              MicroWait( 62500 );
   \   00009A                ; Setup parameters for call to function Onboard_wait
   \   00009A   7A24         MOV     R2,#0x24
   \   00009C   7BF4         MOV     R3,#-0xc
   \   00009E   12....       LCALL   ??Onboard_wait?relay
    290            }
   \                     ??zmain_ext_addr_3:
   \   0000A1                ; Setup parameters for call to function HalKeyRead
   \   0000A1   12....       LCALL   ??HalKeyRead?relay
   \   0000A4   E9           MOV     A,R1
   \   0000A5   6404         XRL     A,#0x4
   \   0000A7   70E0         JNZ     ??zmain_ext_addr_4
    291            HalLedSet( HAL_LED_1, HAL_LED_MODE_OFF );
   \   0000A9                ; Setup parameters for call to function HalLedSet
   \   0000A9   7A00         MOV     R2,#0x0
   \   0000AB   7901         MOV     R1,#0x1
   \   0000AD   12....       LCALL   ??HalLedSet?relay
    292          
    293            // Plug AtoD data into lower bytes
    294            AtoD = HalAdcRead (HAL_ADC_CHANNEL_7, HAL_ADC_RESOLUTION_10);
   \   0000B0                ; Setup parameters for call to function HalAdcRead
   \   0000B0   7A02         MOV     R2,#0x2
   \   0000B2   7907         MOV     R1,#0x7
   \   0000B4   12....       LCALL   ??HalAdcRead?relay
    295            xad = (uint8*)&aExtendedAddress;
    296            *xad++ = LO_UINT16( AtoD );
   \   0000B7   EA           MOV     A,R2
   \   0000B8   90....       MOV     DPTR,#aExtendedAddress
   \   0000BB   F0           MOVX    @DPTR,A
    297            *xad = HI_UINT16( AtoD );
   \   0000BC   EB           MOV     A,R3
   \   0000BD   90....       MOV     DPTR,#(aExtendedAddress + 1)
   \   0000C0   F0           MOVX    @DPTR,A
    298          
    299          #if !defined( ZTOOL_PORT ) || defined( ZPORT ) || defined( NV_RESTORE )
    300            // If no support for Z-Tool serial I/O,
    301            // Write temporary 64-bit address to NV
    302            osal_nv_write( ZCD_NV_EXTADDR, 0, Z_EXTADDR_LEN, &aExtendedAddress );
   \   0000C1                ; Setup parameters for call to function osal_nv_write
   \   0000C1   75....       MOV     ?V0 + 0,#(aExtendedAddress & 0xff)
   \   0000C4   75....       MOV     ?V0 + 1,#((aExtendedAddress >> 8) & 0xff)
   \   0000C7   78..         MOV     R0,#?V0 + 0
   \   0000C9   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000CC   75..08       MOV     ?V0 + 0,#0x8
   \   0000CF   75..00       MOV     ?V0 + 1,#0x0
   \   0000D2   78..         MOV     R0,#?V0 + 0
   \   0000D4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000D7   7C00         MOV     R4,#0x0
   \   0000D9   7D00         MOV     R5,#0x0
   \   0000DB   7A01         MOV     R2,#0x1
   \   0000DD   7B00         MOV     R3,#0x0
   \   0000DF   12....       LCALL   ??osal_nv_write?relay
   \   0000E2   7404         MOV     A,#0x4
   \   0000E4   12....       LCALL   ?DEALLOC_XSTACK8
    303          #endif
    304          }
   \                     ??zmain_ext_addr_1:
   \   0000E7   7F02         MOV     R7,#0x2
   \   0000E9   02....       LJMP    ?FUNC_LEAVE_XDATA

   \                                 In  segment NEAR_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   E582         MOV     A,DPL
   \   000002   24FF         ADD     A,#-0x1
   \   000004   F582         MOV     DPL,A
   \   000006   E583         MOV     A,DPH
   \   000008   34FF         ADDC    A,#-0x1
   \   00000A   F583         MOV     DPH,A
   \   00000C   22           RET

   \                                 In  segment XSP, align 1
    305          
    306          /*********************************************************************
    307           * @fn      zmain_dev_info
    308           * @brief   Gets or makes extended address.
    309           * @return  none
    310           *********************************************************************/
    311          static ZSEG void zmain_dev_info ( void )
    312          {
    313          #ifdef LCD_SUPPORTED
    314            uint8 i;
    315            uint8 ch;
    316            uint8 *xad;
    317            unsigned char lcd_buf[18];
    318          
    319            // Display the extended address
    320            xad = (uint8*)&aExtendedAddress + Z_EXTADDR_LEN - 1;
    321            for ( i = 0; i < Z_EXTADDR_LEN*2; xad-- ) {
    322              ch = (*xad >> 4) & 0x0F;
    323              lcd_buf[i++] = ch + (( ch < 10 ) ? '0' : '7');
    324              ch = *xad & 0x0F;
    325              lcd_buf[i++] = ch + (( ch < 10 ) ? '0' : '7');
    326            }
    327            lcd_buf[Z_EXTADDR_LEN*2] = '\0';
    328            HalLcdWriteString( "IEEE Address:", HAL_LCD_LINE_1 );
    329            HalLcdWriteString( (char*)lcd_buf, HAL_LCD_LINE_2 );
    330          #endif // LCD
    331          }
    332          
    333          /*********************************************************************
    334           * @fn      zmain_ram_init
    335           * @brief   Initialize ram for stack "high-water-mark" observations.
    336           * @return  none
    337           *********************************************************************/
    338          static ZSEG void zmain_ram_init( void )
    339          {
    340            uint8 *end;
    341            uint8 *ptr;
    342          
    343            // Initialize the call (parameter) stack
    344            end = (uint8*)CSTK_BEG;  // Lower end
    345            ptr = (uint8*)(*( __idata uint16*)(CSTK_PTR));  // Upper end
    346            while ( --ptr > end )
    347              *ptr = STACK_INIT_VALUE;
    348          
    349            // Initialize the return (address) stack
    350            ptr = (uint8*)RSTK_END - 1;  // Upper end
    351            while ( --ptr > (uint8*)SP )
    352              *(__idata uint8*)ptr = STACK_INIT_VALUE;
    353          }
    354          
    355          #ifdef LCD_SUPPORTED
    356          /*********************************************************************
    357           * @fn      zmain_lcd_init
    358           * @brief   Initialize LCD at start up.
    359           * @return  none
    360           *********************************************************************/
    361          static ZSEG void zmain_lcd_init ( void )
    362          {
    363          #ifdef LCD_SD
    364           // if ( LcdLine1 == NULL )
    365            {
    366              HalLcdWriteString( "Figure8 Wireless", HAL_LCD_LINE_1 );
    367          
    368          #if defined( MT_MAC_FUNC )
    369          #if defined( ZDO_COORDINATOR )
    370                HalLcdWriteString( "MAC-MT Coord", HAL_LCD_LINE_2 );
    371          #else
    372                HalLcdWriteString( "MAC-MT Device", HAL_LCD_LINE_2 );
    373          #endif // ZDO
    374          #elif defined( MT_NWK_FUNC )
    375          #if defined( ZDO_COORDINATOR )
    376                HalLcdWriteString( "NWK Coordinator", HAL_LCD_LINE_2 );
    377          #else
    378                HalLcdWriteString( "NWK Device", HAL_LCD_LINE_2 );
    379          #endif // ZDO
    380          #endif // MT_FUNC
    381            }
    382          #endif // LCD_SD
    383          }
    384          #endif
    385          
    386          /*********************************************************************
    387          *********************************************************************/

   Maximum stack usage in bytes:

     Function               ISTACK PSTACK XSTACK
     --------               ------ ------ ------
     main                       1      0      0
       -> osal_int_disable      0      0      0
       -> zmain_vdd_check       0      0      0
       -> InitBoard             0      0      0
       -> HalDriverInit         0      0      0
       -> osal_nv_init          0      0      0
       -> zmain_ext_addr        0      0      0
       -> zgInit                0      0      0
       -> ZMacInit              0      0      0
       -> afInit                0      0      0
       -> osal_init_system      0      0      0
       -> osal_int_enable       0      0      0
       -> InitBoard             0      0      0
       -> osal_start_system     0      0      0
     zmain_ext_addr             1      0     13
       -> osal_nv_item_init     0      0     22
       -> osal_nv_read          0      0     26
       -> Onboard_wait          0      0     18
       -> HalLedSet             0      0     18
       -> Onboard_wait          0      0     18
       -> HalKeyRead            0      0     18
       -> HalLedSet             0      0     18
       -> HalAdcRead            0      0     18
       -> osal_nv_write         0      0     26
     zmain_vdd_check            0      0      8
       -> HalAdcCheckVdd        0      0     16
       -> Onboard_wait          0      0     16
       -> Onboard_wait          0      0     16
       -> Onboard_wait          0      0     16


   Segment part sizes:

     Function/Label  Bytes
     --------------  -----
     SP                 1
     P0INP              1
     _A_P1              1
     SLEEP              1
     CLKCON             1
     P1DIR              1
     main             162
     zmain_vdd_check   95
     zmain_ext_addr   236
     ?Subroutine0      13

 
 506 bytes in segment NEAR_CODE
   6 bytes in segment SFR_AN
 
 506 bytes of CODE memory
   0 bytes of DATA memory (+ 6 bytes shared)

Errors: none
Warnings: none
