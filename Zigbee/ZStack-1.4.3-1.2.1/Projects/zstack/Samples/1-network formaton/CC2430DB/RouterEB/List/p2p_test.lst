###############################################################################
#                                                                             #
# IAR 8051 C/C++ Compiler V7.30B/W32                    12/Sep/2012  16:16:39 #
# Copyright 2004-2007 IAR Systems. All rights reserved.                       #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data                                               #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Documents and Settings\Administrator\桌面\8-22\ #
#                          Texas Instruments nongmenshan\ZStack-1.4.3-1.2.1\P #
#                          rojects\zstack\Samples\1-network                   #
#                          formaton\Source\p2p_test.c                         #
#    Command line       =  -f "C:\Documents and Settings\Administrator\桌面\8 #
#                          -22\Texas Instruments nongmenshan\ZStack-1.4.3-1.2 #
#                          .1\Projects\zstack\Samples\1-network               #
#                          formaton\CC2430DB\..\..\..\Tools\CC2430DB\f8wRoute #
#                          r.cfg" (-DCPU32MHZ -DFORCE_MAC_NEAR                #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DRTR_NWK -DBLINK_LEDS "-DCONST=const __code"    #
#                          -DGENERIC=__generic) -f "C:\Documents and          #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\Tools\CC2430DB\f8wConfi #
#                          g.cfg" (-DSECURE=0 -DDEFAULT_CHANLIST=0x00000800   #
#                          -DZDAPP_CONFIG_PAN_ID=0x1234                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=10 -DAPSC_MAX_FRAME_RETRIES=3   #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=20           #
#                          -DNWK_MAX_BINDING_ENTRIES=10                       #
#                          -DMAX_BINDING_CLUSTER_IDS=5 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "C:\Documents and           #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\Source\p2p_test.c" -D CC2430EB -D         #
#                          REFLECTOR -D ZTOOL_P1 -D MT_TASK -D MT_ZDO_FUNC    #
#                          -D xLCD_SUPPORTED=DEBUG -lC "C:\Documents and      #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\RouterEB\List\" -lA              #
#                          "C:\Documents and Settings\Administrator\桌面\8-22 #
#                          \Texas Instruments nongmenshan\ZStack-1.4.3-1.2.1\ #
#                          Projects\zstack\Samples\1-network                  #
#                          formaton\CC2430DB\RouterEB\List\" --diag_suppress  #
#                          Pe001,Pa010 --diag_remark pe550 -o "C:\Documents   #
#                          and Settings\Administrator\桌面\8-22\Texas         #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\RouterEB\Obj\" -e                #
#                          --require_prototypes -z9 --no_code_motion --debug  #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data --nr_virtual_regs 8  #
#                          -I "C:\Documents and Settings\Administrator\桌面\8 #
#                          -22\Texas Instruments nongmenshan\ZStack-1.4.3-1.2 #
#                          .1\Projects\zstack\Samples\1-network               #
#                          formaton\CC2430DB\" -I "C:\Documents and           #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\SOURCE\" -I "C:\Documents     #
#                          and Settings\Administrator\桌面\8-22\Texas         #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\ZMAIN\TI2430DB\" -I     #
#                          "C:\Documents and Settings\Administrator\桌面\8-22 #
#                          \Texas Instruments nongmenshan\ZStack-1.4.3-1.2.1\ #
#                          Projects\zstack\Samples\1-network                  #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MT\"   #
#                          -I "C:\Documents and Settings\Administrator\桌面\8 #
#                          -22\Texas Instruments nongmenshan\ZStack-1.4.3-1.2 #
#                          .1\Projects\zstack\Samples\1-network               #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\HAL\IN #
#                          CLUDE\" -I "C:\Documents and                       #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\HAL\TA #
#                          RGET\CC2430EB\" -I "C:\Documents and               #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\OSAL\M #
#                          CU\CCSOC\" -I "C:\Documents and                    #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\OSAL\I #
#                          NCLUDE\" -I "C:\Documents and                      #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          AF\" -I "C:\Documents and                          #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          NWK\" -I "C:\Documents and                         #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          SEC\" -I "C:\Documents and                         #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          SYS\" -I "C:\Documents and                         #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\STACK\ #
#                          ZDO\" -I "C:\Documents and                         #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\ZMAC\F #
#                          8W\" -I "C:\Documents and                          #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\ZMAC\" #
#                           -I "C:\Documents and Settings\Administrator\桌面\ #
#                          8-22\Texas Instruments nongmenshan\ZStack-1.4.3-1. #
#                          2.1\Projects\zstack\Samples\1-network              #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\SERVIC #
#                          ES\SADDR\" -I "C:\Documents and                    #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\SERVIC #
#                          ES\SDATA\" -I "C:\Documents and                    #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\IN #
#                          CLUDE\" -I "C:\Documents and                       #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\HI #
#                          GH_LEVEL\" -I "C:\Documents and                    #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\LO #
#                          W_LEVEL\SRF03\" -I "C:\Documents and               #
#                          Settings\Administrator\桌面\8-22\Texas             #
#                          Instruments nongmenshan\ZStack-1.4.3-1.2.1\Project #
#                          s\zstack\Samples\1-network                         #
#                          formaton\CC2430DB\..\..\..\..\..\COMPONENTS\MAC\LO #
#                          W_LEVEL\SRF03\SINGLE_CHIP\" -I "D:\IAR             #
#                          Systems\Embedded Workbench 4.0 Evaluation          #
#                          version\8051\INC\" -I "D:\IAR Systems\Embedded     #
#                          Workbench 4.0 Evaluation version\8051\INC\CLIB\"   #
#    List file          =  C:\Documents and Settings\Administrator\桌面\8-22\ #
#                          Texas Instruments nongmenshan\ZStack-1.4.3-1.2.1\P #
#                          rojects\zstack\Samples\1-network                   #
#                          formaton\CC2430DB\RouterEB\List\p2p_test.lst       #
#    Object file        =  C:\Documents and Settings\Administrator\桌面\8-22\ #
#                          Texas Instruments nongmenshan\ZStack-1.4.3-1.2.1\P #
#                          rojects\zstack\Samples\1-network                   #
#                          formaton\CC2430DB\RouterEB\Obj\p2p_test.r51        #
#                                                                             #
#                                                                             #
###############################################################################

C:\Documents and Settings\Administrator\桌面\8-22\Texas Instruments nongmenshan\ZStack-1.4.3-1.2.1\Projects\zstack\Samples\1-network formaton\Source\p2p_test.c
      1          /**************************************************************************************************
      2            Filename:       p2p_test.c
      3            Revised:        $Date: 2007-10-27 17:16:54 -0700 (Sat, 27 Oct 2007) $
      4            Revision:       $Revision: 15793 $
      5          
      6            Description:    Generic Application (no Profile).
      7          
      8          
      9            Copyright 2004-2007 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends "Hello World" to another "Generic"
     45            application every 15 seconds.  The application will also
     46            receive "Hello World" packets.
     47          
     48            The "Hello World" messages are sent/received as MSG type message.
     49          
     50            This applications doesn't have a profile, so it handles everything
     51            directly - itself.
     52          
     53            Key control:
     54              SW1:
     55              SW2:  initiates end device binding
     56              SW3:
     57              SW4:  initiates a match description request
     58          *********************************************************************/
     59          
     60          /*********************************************************************
     61           * INCLUDES
     62           */
     63          #include "OSAL.h"
     64          #include "AF.h"
     65          #include "ZDApp.h"
     66          #include "ZDObject.h"
     67          #include "ZDProfile.h"
     68          
     69          #include "p2p_test.h"
     70          #include "DebugTrace.h"
     71          
     72          #if !defined( WIN32 )
     73            #include "OnBoard.h"
     74          #endif
     75          
     76          /* HAL */
     77          #include "hal_lcd.h"
     78          #include "hal_led.h"
     79          #include "hal_key.h"
     80          #include "hal_uart.h"
     81          //#include "Hal_Sensor.h"  
     82          #include "Hal_defs.h"
     83          #include "hal_adc.h"
     84          /*********************************************************************
     85           * MACROS
     86           */
     87           #define DATA P1_1
     88          
     89          #define SCK P1_0
     90          
     91          /*********************************************************************
     92           * CONSTANTS
     93           */
     94          #define CLKSPD_1  (CLKCON & 0x01)
     95          
     96          
     97          // This list should be filled with Application specific Cluster IDs.
     98          /*********************************************************************
     99           * TYPEDEFS
    100           */
    101          
    102          /*********************************************************************
    103           * GLOBAL VARIABLES
    104           */
    105          
    106          // This list should be filled with Application specific Cluster IDs.
    107          const cId_t p2p_test_ClusterList[p2p_test_MAX_CLUSTERS] =
    108          {
    109            p2p_test_CLUSTERID,
    110            //fire_extinguisher_clusterId
    111          };
    112          
    113          const SimpleDescriptionFormat_t p2p_test_SimpleDesc =
    114          {
    115            p2p_test_ENDPOINT,              //  int Endpoint;
    116            p2p_test_PROFID,                //  uint16 AppProfId[2];
    117            p2p_test_DEVICEID,              //  uint16 AppDeviceId[2];
    118            p2p_test_DEVICE_VERSION,        //  int   AppDevVer:4;
    119            p2p_test_FLAGS,                 //  int   AppFlags:4;
    120            p2p_test_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    121            (cId_t *)p2p_test_ClusterList,  //  byte *pAppInClusterList;
    122            p2p_test_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    123            (cId_t *)p2p_test_ClusterList   //  byte *pAppInClusterList;
    124          };
    125          
    126          // This is the Endpoint/Interface description.  It is defined here, but
    127          // filled-in in p2p_test_Init().  Another way to go would be to fill
    128          // in the structure here and make it a "const" (in code space).  The
    129          // way it's defined in this sample app it is define in RAM.
    130          endPointDesc_t p2p_test_epDesc;
    131          
    132          /*********************************************************************
    133           * EXTERNAL VARIABLES
    134           */
    135          
    136          /*********************************************************************
    137           * EXTERNAL FUNCTIONS
    138           */
    139          
    140          /*********************************************************************
    141           * LOCAL VARIABLES
    142           */
    143          byte p2p_test_TaskID;   // Task ID for internal task/event processing
    144                                    // This variable will be received when
    145                                    // p2p_test_Init() is called.
    146          devStates_t p2p_test_NwkState;
    147          
    148          
    149          byte p2p_test_TransID;  // This is the unique message ID (counter)
    150          
    151          
    152          byte p2p_test_TransID;  // This is the unique message ID (counter)
    153          
    154          afAddrType_t p2p_test_DstAddr;
    155            uint8 p2p_msg[6];//the collect message
    156           uint16 shortaddr;
    157           uint16 fatheraddr;
    158          
    159          /*********************************************************************
    160           * LOCAL FUNCTIONS
    161           */
    162          void p2p_test_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg );
    163          void p2p_test_HandleKeys( byte shift, byte keys );
    164          void p2p_test_MessageMSGCB( afIncomingMSGPacket_t *pckt );
    165          void p2p_test_SendTheMessage( void );
    166          
    167          /*********************************************************************
    168           * NETWORK LAYER CALLBACKS
    169           */
    170          
    171          /*********************************************************************
    172           * PUBLIC FUNCTIONS
    173           */
    174          
    175          /*********************************************************************
    176           * @fn      p2p_test_Init
    177           *
    178           * @brief   Initialization function for the Generic App Task.
    179           *          This is called during initialization and should contain
    180           *          any application specific initialization (ie. hardware
    181           *          initialization/setup, table initialization, power up
    182           *          notificaiton ... ).
    183           *
    184           * @param   task_id - the ID assigned by OSAL.  This ID should be
    185           *                    used to send messages and set timers.
    186           *
    187           * @return  none
    188           */
    189          void p2p_test_Init( byte task_id )
    190          {
    191            p2p_test_TaskID = task_id;
    192            p2p_test_NwkState = DEV_INIT;
    193            p2p_test_TransID = 0;
    194          
    195            // Device hardware initialization can be added here or in main() (Zmain.c).
    196            // If the hardware is application specific - add it here.
    197            // If the hardware is other parts of the device add it in main().
    198          
    199            p2p_test_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    200            p2p_test_DstAddr.endPoint = p2p_test_ENDPOINT;
    201            p2p_test_DstAddr.addr.shortAddr = 0x0000;
    202          
    203            // Fill out the endpoint description.
    204            p2p_test_epDesc.endPoint = p2p_test_ENDPOINT;
    205            p2p_test_epDesc.task_id = &p2p_test_TaskID;
    206            p2p_test_epDesc.simpleDesc
    207                      = (SimpleDescriptionFormat_t *)&p2p_test_SimpleDesc;
    208            p2p_test_epDesc.latencyReq = noLatencyReqs;
    209          
    210            // Register the endpoint description with the AF
    211            afRegister( &p2p_test_epDesc );
    212          
    213            // Register for all key events - This app will handle all key events
    214            RegisterForKeys( p2p_test_TaskID );
    215          
    216          
    217          
    218            // Update the display
    219          #if defined ( LCD_SUPPORTED )
    220              HalLcdWriteString( "p2p_test", HAL_LCD_LINE_1 );
    221          #endif
    222          
    223            ZDO_RegisterForZDOMsg( p2p_test_TaskID, End_Device_Bind_rsp );
    224            ZDO_RegisterForZDOMsg( p2p_test_TaskID, Match_Desc_rsp );
    225          }
    226          
    227          /*********************************************************************
    228           * @fn      p2p_test_ProcessEvent
    229           *
    230           * @brief   Generic Application Task event processor.  This function
    231           *          is called to process all events for the task.  Events
    232           *          include timers, messages and any other user defined events.
    233           *
    234           * @param   task_id  - The OSAL assigned task ID.
    235           * @param   events - events to process.  This is a bit map and can
    236           *                   contain more than one event.
    237           *
    238           * @return  none
    239           */
    240          UINT16 p2p_test_ProcessEvent( byte task_id, UINT16 events )
    241          {
    242            afIncomingMSGPacket_t *MSGpkt;
    243            afDataConfirm_t *afDataConfirm;
    244          
    245            // Data Confirmation message fields
    246            byte sentEP;
    247            ZStatus_t sentStatus;
    248            byte sentTransID;       // This should match the value sent
    249          
    250            if ( events & SYS_EVENT_MSG )
    251            {
    252              MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( p2p_test_TaskID );
    253              while ( MSGpkt )
    254              {
    255                switch ( MSGpkt->hdr.event )
    256                {
    257                  case ZDO_CB_MSG:
    258                    p2p_test_ProcessZDOMsgs( (zdoIncomingMsg_t *)MSGpkt );
    259                    break;
    260          
    261                  case KEY_CHANGE:
    262                    // p2p_test_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    263                    
    264                    break;
    265                case INTER_CHANGE:
                            ^
Error[Pe020]: identifier "INTER_CHANGE" is undefined
    266                    p2p_test_SendRainfall();
    267                    break;
    268          
    269                  case AF_DATA_CONFIRM_CMD:
    270                    // This message is received as a confirmation of a data packet sent.
    271                    // The status is of ZStatus_t type [defined in ZComDef.h]
    272                    // The message fields are defined in AF.h
    273                    afDataConfirm = (afDataConfirm_t *)MSGpkt;
    274                    sentEP = afDataConfirm->endpoint;
    275                    sentStatus = afDataConfirm->hdr.status;
    276                    sentTransID = afDataConfirm->transID;
    277                    (void)sentEP;
    278                    (void)sentTransID;
    279          
    280                    // Action taken when confirmation is received.
    281                    if ( sentStatus != ZSuccess )
    282                    {
    283                      // The data wasn't delivered -- Do something
    284                    }
    285                    break;
    286          
    287                  case AF_INCOMING_MSG_CMD:
    288                    p2p_test_MessageMSGCB( MSGpkt );
    289                    
    290           //         HalLedSet( HAL_LED_1, HAL_LED_MODE_ON );
    291            //        MicroWait( 62500 );
    292            //        MicroWait( 62500 );
    293             //       HalLedSet( HAL_LED_1, HAL_LED_MODE_OFF );
    294                    break;
    295          
    296                  case ZDO_STATE_CHANGE:
    297                    p2p_test_NwkState = (devStates_t)(MSGpkt->hdr.status);
    298                    if (  (p2p_test_NwkState == DEV_ROUTER)
    299                        || (p2p_test_NwkState == DEV_END_DEVICE) )
    300                    {
    301                        //osal_start_timerEx( p2p_test_TaskID,
    302                        //                  p2p_test_SEND_MSG_EVT,
    303                        //                 10 );
    304                    }
    305                    break;
    306          
    307                  default:
    308                    break;
    309                }
    310          
    311                // Release the memory
    312                osal_msg_deallocate( (uint8 *)MSGpkt );
    313          
    314                // Next
    315                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( p2p_test_TaskID );
    316              }
    317          
    318              // return unprocessed events
    319              return (events ^ SYS_EVENT_MSG);
    320            }
    321          
    322            // Send a message out - This event is generated by a timer
    323            //  (setup in p2p_test_Init()).
    324            if ( events & p2p_test_SEND_MSG_EVT )
    325            {
    326              p2p_msg[0] = 0xFF;
    327              //next is for ieeaddr
    328              shortaddr = NLME_GetShortAddr();
    329              p2p_msg[1] = LO_UINT16(shortaddr);
    330              p2p_msg[2] = HI_UINT16(shortaddr);
    331              fatheraddr = NLME_GetCoordShortAddr();
    332              p2p_msg[3] = LO_UINT16(fatheraddr);
    333              p2p_msg[4] = HI_UINT16(fatheraddr);
    334              uint8 *ieeeAddr;
    335              ieeeAddr = NLME_GetExtAddr();
    336              p2p_msg[5]=  *(uint8 *)(ieeeAddr+7);//p2p_DeviceID; 
    337              // Send "the" message
    338              p2p_test_SendTheMessage();
    339              osal_start_timerEx( p2p_test_TaskID,
    340                                  p2p_test_SEND_MSG_EVT,
    341                                  p2p_test_SEND_MSG_TIMEOUT );
    342          
    343              // return unprocessed events
    344              return (events ^ p2p_test_SEND_MSG_EVT);
    345            }
    346          
    347            // Discard unknown events
    348            return 0;
    349          }
    350          
    351          /*********************************************************************
    352           * Event Generation Functions
    353           */
    354          /*********************************************************************
    355           * @fn      p2p_test_ProcessZDOMsgs()
    356           *
    357           * @brief   Process response messages
    358           *
    359           * @param   none
    360           *
    361           * @return  none
    362           */
    363          void p2p_test_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg )
    364          {
    365            switch ( inMsg->clusterID )
    366            {
    367              case End_Device_Bind_rsp:
    368                if ( ZDO_ParseBindRsp( inMsg ) == ZSuccess )
    369                {
    370                  // Light LED
    371                  HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    372                }
    373          #if defined(BLINK_LEDS)
    374                else
    375                {
    376                  // Flash LED to show failure
    377                  HalLedSet ( HAL_LED_4, HAL_LED_MODE_FLASH );
    378                }
    379          #endif
    380                break;
    381          
    382              case Match_Desc_rsp:
    383                {
    384                  ZDO_ActiveEndpointRsp_t *pRsp = ZDO_ParseEPListRsp( inMsg );
    385                  if ( pRsp )
    386                  {
    387                    if ( pRsp->status == ZSuccess && pRsp->cnt )
    388                    {
    389                      p2p_test_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    390                      p2p_test_DstAddr.addr.shortAddr = pRsp->nwkAddr;
    391                      // Take the first endpoint, Can be changed to search through endpoints
    392                      p2p_test_DstAddr.endPoint = pRsp->epList[0];
    393          
    394                      // Light LED
    395                      HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    396                    }
    397                    osal_mem_free( pRsp );
    398                  }
    399                }
    400                break;
    401            }
    402          }
    403          
    404          /*********************************************************************
    405           * @fn      p2p_test_HandleKeys
    406           *
    407           * @brief   Handles all key events for this device.
    408           *
    409           * @param   shift - true if in shift/alt.
    410           * @param   keys - bit field for key events. Valid entries:
    411           *                 HAL_KEY_SW_4
    412           *                 HAL_KEY_SW_3
    413           *                 HAL_KEY_SW_2
    414           *                 HAL_KEY_SW_1
    415           *
    416           * @return  none
    417           */
    418          void p2p_test_SendRainfall(void)
    419          {
    420            if (  (p2p_test_NwkState == DEV_ROUTER)
    421                        || (p2p_test_NwkState == DEV_END_DEVICE) )
    422            {
    423              unsigned char p2p_msg[3];
    424              p2p_msg[0] = HI_UINT16(shortaddr);
    425              p2p_msg[1] = LO_UINT16(shortaddr);
    426              p2p_msg[2] = 1;
    427              
    428              AF_DataRequest( &p2p_test_DstAddr, &p2p_test_epDesc,
    429                                 p2p_test_CLUSTERID,
    430                                 3,
    431                                 (byte *)&p2p_msg,
    432                                 &p2p_test_TransID,
    433                                 AF_DISCV_ROUTE, AF_DEFAULT_RADIUS );
    434            }
    435          }
    436          void p2p_test_HandleKeys( byte shift, byte keys )
    437          {
    438            zAddrType_t dstAddr;
    439          
    440            // Shift is used to make each button/switch dual purpose.
    441            if ( shift )
    442            {
    443              if ( keys & HAL_KEY_SW_1 )
    444              {
    445              }
    446              if ( keys & HAL_KEY_SW_2 )
    447              {
    448              }
    449              if ( keys & HAL_KEY_SW_3 )
    450              {
    451              }
    452              if ( keys & HAL_KEY_SW_4 )
    453              {
    454              }
    455            }
    456            else
    457            {
    458              if ( keys & HAL_KEY_SW_1 )
    459              {
    460              }
    461          
    462              if ( keys & HAL_KEY_SW_2 )
    463              {
    464                HalLedSet ( HAL_LED_4, HAL_LED_MODE_OFF );
    465          
    466                // Initiate an End Device Bind Request for the mandatory endpoint
    467                dstAddr.addrMode = Addr16Bit;
    468                dstAddr.addr.shortAddr = 0x0000; // Coordinator
    469                ZDP_EndDeviceBindReq( &dstAddr, NLME_GetShortAddr(),
    470                                      p2p_test_epDesc.endPoint,
    471                                      p2p_test_PROFID,
    472                                      p2p_test_MAX_CLUSTERS, (cId_t *)p2p_test_ClusterList,
    473                                      p2p_test_MAX_CLUSTERS, (cId_t *)p2p_test_ClusterList,
    474                                      FALSE );
    475              }
    476          
    477              if ( keys & HAL_KEY_SW_3 )
    478              {
    479              }
    480          
    481              if ( keys & HAL_KEY_SW_4 )
    482              {
    483                HalLedSet ( HAL_LED_4, HAL_LED_MODE_OFF );
    484          
    485                // Initiate a Match Description Request (Service Discovery)
    486                dstAddr.addrMode = AddrBroadcast;
    487                dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR;
    488                ZDP_MatchDescReq( &dstAddr, NWK_BROADCAST_SHORTADDR,
    489                                  p2p_test_PROFID,
    490                                  p2p_test_MAX_CLUSTERS, (cId_t *)p2p_test_ClusterList,
    491                                  p2p_test_MAX_CLUSTERS, (cId_t *)p2p_test_ClusterList,
    492                                  FALSE );
    493              }
    494            }
    495          }
    496          
    497          /*********************************************************************
    498           * LOCAL FUNCTIONS
    499           */
    500          
    501          /*********************************************************************
    502           * @fn      p2p_test_MessageMSGCB
    503           *
    504           * @brief   Data message processor callback.  This function processes
    505           *          any incoming data - probably from other devices.  So, based
    506           *          on cluster ID, perform the intended action.
    507           *
    508           * @param   none
    509           *
    510           * @return  none
    511           */
    512          void p2p_test_MessageMSGCB( afIncomingMSGPacket_t *pkt )
    513          {
    514            uint8 msg_head[2];
    515            uint8 check;
    516            switch ( pkt->clusterId )
    517            {
    518              case p2p_test_CLUSTERID:
    519                // "the" message
    520                //the head
    521                msg_head[0] = 0xAA;
    522                msg_head[1] = 0x55;
    523                check = 0x01; //test, not true
    524                HalUARTWrite( 0, (uint8*)msg_head, 2 );
    525                HalUARTWrite( 0, (uint8*)pkt->cmd.Data, pkt->cmd.DataLength );
    526                HalUARTWrite( 0, &check, 1 );
    527                break;
    528             
    529            }
    530          }
    531          
    532          
    533          /*********************************************************************
    534           * @fn      p2p_test_SendTheMessage
    535           *
    536           * @brief   Send "the" message.
    537           *
    538           * @param   none
    539           *
    540           * @return  none
    541           */
    542          void p2p_test_SendTheMessage( void )
    543          {
    544             //char p2p_msg[] = "Hello World ";
    545             if ( AF_DataRequest( &p2p_test_DstAddr, &p2p_test_epDesc,
    546                                 p2p_test_CLUSTERID,
    547                                 6,
    548                                 (byte *)&p2p_msg,
    549                                 &p2p_test_TransID,
    550                                 AF_DISCV_ROUTE, AF_DEFAULT_RADIUS ) == afStatus_SUCCESS )
    551          
    552            {
    553              // Successfully requested to be sent.  
    554          //    HalUARTWrite( 0,  (uint8 *)p2p_msg, (byte)osal_strlen( p2p_msg ) + 1);
    555          
    556            } 
    557            
    558            else
    559            {
    560              // Error occurred in request to send.
    561            }
    562          }
    563          
    564          
    565          

Errors: 1
Warnings: none
